<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Module: Nelumbo::WorldTracking</title>

  <link rel="stylesheet" href="../rdoc.css" type="text/css" media="screen" />

  <script src="../js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="../js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="module">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="../lib/nelumbo/world_tracking_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="lib/nelumbo/world_tracking.rb">lib/nelumbo/world_tracking.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      

      

      
      <!-- Namespace Contents -->
      <div id="namespace-list-section" class="section">
        <h3 class="section-header">Namespace</h3>
        <ul class="link-list">
          
          <li><span class="type">MODULE</span> <a href="WorldTracking/AdvancedImplementation.html">Nelumbo::WorldTracking::AdvancedImplementation</a></li>
          
          <li><span class="type">MODULE</span> <a href="WorldTracking/ClassMethods.html">Nelumbo::WorldTracking::ClassMethods</a></li>
          
          <li><span class="type">MODULE</span> <a href="WorldTracking/SimpleImplementation.html">Nelumbo::WorldTracking::SimpleImplementation</a></li>
          
        </ul>
      </div>
      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-included">::included</a></li>
          
          <li><a href="#method-i-find_player">#find_player</a></li>
          
          <li><a href="#method-i-find_player-21">#find_player!</a></li>
          
          <li><a href="#method-i-request_player_by_uid">#request_player_by_uid</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../Gemfile.html">Gemfile</a></li>
        
          <li class="file"><a href="../Rakefile.html">Rakefile</a></li>
        
          <li class="file"><a href="../tmp/java/nelumbo/1_8_7/Makefile.html">Makefile</a></li>
        
          <li class="file"><a href="../tmp/x86_64-linux/nelumbo/1_9_2/Makefile.html">Makefile</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../Nelumbo.html">Nelumbo</a></li>
        
          <li><a href="../Nelumbo/BaseBot.html">Nelumbo::BaseBot</a></li>
        
          <li><a href="../Nelumbo/Bot.html">Nelumbo::Bot</a></li>
        
          <li><a href="../Nelumbo/CoreHooks.html">Nelumbo::CoreHooks</a></li>
        
          <li><a href="../Nelumbo/EventDSL.html">Nelumbo::EventDSL</a></li>
        
          <li><a href="../Nelumbo/EventHandler.html">Nelumbo::EventHandler</a></li>
        
          <li><a href="../Nelumbo/Plugin.html">Nelumbo::Plugin</a></li>
        
          <li><a href="../Nelumbo/Script.html">Nelumbo::Script</a></li>
        
          <li><a href="../Nelumbo/Script/DragonSpeak.html">Nelumbo::Script::DragonSpeak</a></li>
        
          <li><a href="../Nelumbo/Script/Language.html">Nelumbo::Script::Language</a></li>
        
          <li><a href="../Nelumbo/Script/LanguageDSL.html">Nelumbo::Script::LanguageDSL</a></li>
        
          <li><a href="../Nelumbo/Script/LanguageDSL/CategoryProxy.html">Nelumbo::Script::LanguageDSL::CategoryProxy</a></li>
        
          <li><a href="../Nelumbo/Script/LanguageDSL/LineProxy.html">Nelumbo::Script::LanguageDSL::LineProxy</a></li>
        
          <li><a href="../Nelumbo/Script/LineParser.html">Nelumbo::Script::LineParser</a></li>
        
          <li><a href="../Nelumbo/Script/Tokenizer.html">Nelumbo::Script::Tokenizer</a></li>
        
          <li><a href="../Nelumbo/Script/TreeParser.html">Nelumbo::Script::TreeParser</a></li>
        
          <li><a href="../Nelumbo/SelectCore.html">Nelumbo::SelectCore</a></li>
        
          <li><a href="../Nelumbo/SimpleCore.html">Nelumbo::SimpleCore</a></li>
        
          <li><a href="../Nelumbo/World.html">Nelumbo::World</a></li>
        
          <li><a href="../Nelumbo/World/Context.html">Nelumbo::World::Context</a></li>
        
          <li><a href="../Nelumbo/World/Player.html">Nelumbo::World::Player</a></li>
        
          <li><a href="../Nelumbo/WorldTracking.html">Nelumbo::WorldTracking</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/AdvancedImplementation.html">Nelumbo::WorldTracking::AdvancedImplementation</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/AdvancedImplementation/ClassMethods.html">Nelumbo::WorldTracking::AdvancedImplementation::ClassMethods</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/ClassMethods.html">Nelumbo::WorldTracking::ClassMethods</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/SimpleImplementation.html">Nelumbo::WorldTracking::SimpleImplementation</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/SimpleImplementation/ClassMethods.html">Nelumbo::WorldTracking::SimpleImplementation::ClassMethods</a></li>
        
          <li><a href="../Nelumbo/WorldTracking/SimpleImplementation/Player.html">Nelumbo::WorldTracking::SimpleImplementation::Player</a></li>
        
          <li><a href="../Array.html">Array</a></li>
        
          <li><a href="../Integer.html">Integer</a></li>
        
          <li><a href="../Numeric.html">Numeric</a></li>
        
          <li><a href="../Object.html">Object</a></li>
        
          <li><a href="../String.html">String</a></li>
        
          <li><a href="../TestBot.html">TestBot</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="module">Nelumbo::WorldTracking</h1>

    <div id="description" class="description">
      
<p>This module allows a bot to track the world around it. It has different
features depending on whether the C extensions are loaded or not.</p>

<h2>Without Extensions</h2>

<p>A pure-Ruby implementation is used. It tracks players in and around the
dream using the avatar/movement info.</p>

<h2>With Extensions</h2>

<p>A full DragonSpeak engine (for dreams where the source files are available)
is implemented, in addition to the aforementioned feature.</p>

<p>To register a dream’s source files with the bot, the register_source_dream
method is called. Each dream URL is associated with one source dream. The
amount of DS lines reported by the server is checked against the DS file to
try and make sure it’s the correct dream (although obviously this won’t be
foolproof).</p>

<h3>DS Engine Caveats</h3>

<p>This engine is capable of tracking almost all changes in the dream (both
player and map wise). It can even track players around the dream
accurately, with a couple of caveats preventing it from being 100% perfect:</p>
<ul><li>
<p>The (5:15) and (5:17) DS lines cannot be used, since the server randomly
generates a target position and doesn’t tell the client what it is.</p>
</li><li>
<p>The (5:19) line cannot be used, since it needs to know the direction that
“any furre present” is facing and the server only divulges this information
for the triggering furre and visible players.</p>
</li><li>
<p>Code which relies on areas iterating through positions in a specific order
(which probably only affects Move/Copy/Swap Object/Floor/Wall) may not work
correctly, because I haven’t figured out the exact orders that Furcadia
uses and I don’t want to mess around with diamonds any more.</p>
</li><li>
<p>Full copies of the original map, DS and FOX files are required, since
third-party applications are forbidden from decrypting dreams (for good
reason) and I don’t want to implement the file server protocol anyway.</p>
</li></ul>

<h3>DragonSpeak Annotations</h3>

<p>An annotation is a Nelumbo-specific instruction inserted into the DS file.
Each line can have one annotation attached to it.</p>

<p>To specify one, add a comment starting with [NB] directly above the
corresponding DS line. For example:</p>

<pre>*[NB] event do_something_cool
(5:200) emit message {Something cool is being done!}.</pre>

<p>The current version of <a href="../Nelumbo.html">Nelumbo</a> only supports
one kind of annotation. All others are ignored.</p>
<dl class="rdoc-list"><dt>event <em>name</em></dt>
<dd>
<p>Raises <tt>:ds_event</tt> and passes the specified event name when the
associated line is executed. It currently only works with effects: this
restriction will be lifted later.</p>
</dd></dl>

<h3>Note about X Positions</h3>

<p>Furcadia internally stores X positions halved - for example, a 300x300 map
is really a 150x300 map. You will never see an odd X position unless you
are dealing with walls.</p>

<p>All public API methods accept and return doubled X positions (as used in
DragonSpeak and DreamEd), including Player#x.</p>

<p>For the C implementation, it’s a little more complicated. Every internal
function uses halved positions, but those accessible through Ruby methods
use doubled positions.</p>

<h2>Events</h2>

<p><a href="WorldTracking.html">WorldTracking</a> will raise these events:</p>
<dl class="rdoc-list"><dt>player_entered</dt>
<dd>
<p>A player entered the dream. Data: <tt>:player</tt>, <tt>:uid</tt>,
<tt>:shortname</tt>, <tt>:flags</tt></p>
</dd><dt>player_left</dt>
<dd>
<p>A player left the dream. Data: <tt>:player</tt>, <tt>:uid</tt>,
<tt>:shortname</tt></p>
</dd><dt>player_move</dt>
<dd>
<p>A player moved. The bot will trigger this whenever it finds out about a
position change. (Sources include the avatar info lines, DS trigger
positions and others.) Data: <tt>:player</tt>, <tt>:from_x</tt>,
<tt>:from_y</tt>, <tt>:to_x</tt>, <tt>:to_y</tt></p>
</dd><dt>player_afk</dt>
<dd>
<p>A player went AFK. Data: <tt>:player</tt></p>
</dd><dt>player_unafk</dt>
<dd>
<p>A player came back from being AFK. Data: <tt>:player</tt>,
<tt>:duration</tt> (in seconds)</p>
</dd></dl>

<p><a href="WorldTracking.html">WorldTracking</a> will raise these events if
the DS engine is active:</p>
<dl class="rdoc-list"><dt>ds_event</dt>
<dd>
<p>A DragonSpeak event was raised. See the section on annotations above. Data:
<tt>:name</tt> (name of the event that was raised)</p>
</dd></dl>

    </div><!-- description -->

    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      

      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="included-method" class="method-detail ">
          <a name="method-c-included"></a>

          
          <div class="method-heading">
            <span class="method-name">included</span><span
              class="method-args">(klass)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            
            

            
            <div class="method-source-code" id="included-source">
<pre>
<span class="ruby-comment"># File lib/nelumbo/world_tracking.rb, line 524</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">included</span>(<span class="ruby-identifier">klass</span>)
        <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">extend</span> <span class="ruby-constant">ClassMethods</span>

        <span class="ruby-keyword">if</span> <span class="ruby-constant">Nelumbo</span>.<span class="ruby-identifier">const_defined?</span>(<span class="ruby-value">:World</span>) <span class="ruby-keyword">and</span> <span class="ruby-constant">Nelumbo</span><span class="ruby-operator">::</span><span class="ruby-constant">World</span>.<span class="ruby-identifier">const_defined?</span>(<span class="ruby-value">:Context</span>)
                <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">send</span> <span class="ruby-value">:include</span>, <span class="ruby-constant">AdvancedImplementation</span>
                <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">extend</span> <span class="ruby-constant">AdvancedImplementation</span><span class="ruby-operator">::</span><span class="ruby-constant">ClassMethods</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">send</span> <span class="ruby-value">:include</span>, <span class="ruby-constant">SimpleImplementation</span>
                <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">extend</span> <span class="ruby-constant">SimpleImplementation</span><span class="ruby-operator">::</span><span class="ruby-constant">ClassMethods</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">setup_world_tracking</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- included-source -->
            
          </div>

          

          
        </div><!-- included-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="find_player-method" class="method-detail ">
          <a name="method-i-find_player"></a>

          
          <div class="method-heading">
            <span class="method-name">find_player</span><span
              class="method-args">(one, two=nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Returns a Player matching either a user ID (<a
href="../Numeric.html">Numeric</a>), name (<a
href="../String.html">String</a>) or position (<a
href="../Numeric.html">Numeric</a>, <a href="../Numeric.html">Numeric</a>).
Pretty much just a convenience function.</p>
            

            
            <div class="method-source-code" id="find_player-source">
<pre>
<span class="ruby-comment"># File lib/nelumbo/world_tracking.rb, line 498</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_player</span>(<span class="ruby-identifier">one</span>, <span class="ruby-identifier">two</span>=<span class="ruby-keyword">nil</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">find_player_at_position</span>(<span class="ruby-identifier">one</span>, <span class="ruby-identifier">two</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">two</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">find_player_by_name</span>(<span class="ruby-identifier">one</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">one</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">find_player_by_uid</span>(<span class="ruby-identifier">one</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- find_player-source -->
            
          </div>

          

          
        </div><!-- find_player-method -->

      
        <div id="find_player-21-method" class="method-detail ">
          <a name="method-i-find_player-21"></a>

          
          <div class="method-heading">
            <span class="method-name">find_player!</span><span
              class="method-args">(one, two=nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Identical to <a
href="WorldTracking.html#method-i-find_player">find_player</a>, but halts
the event if the user cannot be found.</p>
            

            
            <div class="method-source-code" id="find_player-21-source">
<pre>
<span class="ruby-comment"># File lib/nelumbo/world_tracking.rb, line 506</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">find_player!</span>(<span class="ruby-identifier">one</span>, <span class="ruby-identifier">two</span>=<span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">p</span> = <span class="ruby-identifier">find_player</span>(<span class="ruby-identifier">one</span>, <span class="ruby-identifier">two</span>)
        <span class="ruby-identifier">halt</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">nil?</span>
        <span class="ruby-identifier">p</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- find_player-21-source -->
            
          </div>

          

          
        </div><!-- find_player-21-method -->

      
        <div id="request_player_by_uid-method" class="method-detail ">
          <a name="method-i-request_player_by_uid"></a>

          
          <div class="method-heading">
            <span class="method-name">request_player_by_uid</span><span
              class="method-args">(uid)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Returns a Player matching the specified user ID. If it isn’t known to the
bot, it requests the server to resend it and halts the current event.</p>
            

            
            <div class="method-source-code" id="request_player_by_uid-source">
<pre>
<span class="ruby-comment"># File lib/nelumbo/world_tracking.rb, line 515</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">request_player_by_uid</span>(<span class="ruby-identifier">uid</span>)
        <span class="ruby-identifier">player</span> = <span class="ruby-identifier">find_player_by_uid</span>(<span class="ruby-identifier">uid</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">player</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">player</span>.<span class="ruby-identifier">nil?</span>

        <span class="ruby-identifier">write_line</span> <span class="ruby-node">&quot;rev #{uid.encode_b220(4)}&quot;</span>
        <span class="ruby-identifier">halt</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- request_player_by_uid-source -->
            
          </div>

          

          
        </div><!-- request_player_by_uid-method -->

      
      </div><!-- public-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

